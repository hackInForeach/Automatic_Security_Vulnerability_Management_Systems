# analyze_with_port.py

# Python'un logging modülü, uygulama içinde oluşan olayların (logların) kaydedilmesi için kullanılır.
# Loglama, hata ayıklama, performans takibi ve sistem izleme gibi durumlarda oldukça yararlıdır.
import logging

# Python'un subprocess modülü, harici komutları çalıştırmak ve bu komutların çıktılarını işlemek için kullanılır.
# Bu modül, başka programları çağırma, betikleri çalıştırma ve sistem komutlarını yürütme gibi işlemleri yapmamızı sağlar.
import subprocess


def analyze_and_save_vulnerabilities(target):
    """
    Belirtilen hedef IP adresi için port taraması yapar ve açık portlar hakkında bilgi toplar.

    Args:
        target (str): Taramak istenen hedef IP adresi.
    """
    # Mevcut logger'ı al
    logger = logging.getLogger()

    try:
        # Hedef IP adresi için güvenlik açıklarını taramaya başla
        logger.info(f"Başlatılıyor: {target} için IP-PORT-STATE-SERVICES bilgileri toplanıyor...")

        # Güvenlik açığı tarama komutunu hazırla
        # Powershell üzerinden Nmap komutunu çalıştırır
        command = f"powershell -Command \"nmap -sT -Pn {target}\""

        # Komutu çalıştır ve çıktıyı al
        result = subprocess.run(command, shell=True, capture_output=True, text=True)

        # Komut başarılı ise
        if result.returncode == 0:
            # Çıktıyı 'analyze_with_port.log' dosyasına kaydet
            with open('log/analyze_with_port.log', 'w') as file:
                for line in result.stdout.split('\n'):
                    # Satırdaki boşlukları temizle
                    line = line.strip()

                    # Boş satırları geç
                    if line:
                        # 'PORT STATE' başlığını atla ve bu başlıktan sonraki verileri işle
                        if line.startswith('PORT STATE'):
                            continue

                        # Port ve hizmet bilgilerini ayıkla
                        if line and any(char.isdigit() for char in line):
                            # Satırı boşluklara göre böl
                            parts = line.split()

                            # Satırın yeterli bilgi içerdiğinden emin ol
                            if len(parts) >= 3:
                                # Port ve protokolü ayır
                                port = parts[0].split('/')[0]
                                # Port durumu
                                state = parts[1]
                                # Hizmet adını al
                                service_name = ' '.join(parts[2:])

                                # Yalnızca açık portları kaydet
                                if state == 'open':
                                    # Hedef IP adresi
                                    ip = target
                                    # Bilgileri dosyaya yaz
                                    file.write(f"{ip};{port};{state};{service_name}\n")

            # Analiz sonuçları kaydedildiğinde bilgi mesajı ver
            logger.info("Analiz sonuçları log/analyze_with_port.log dosyasına kaydedildi.")

        else:
            # Komut çalışmazsa hata mesajı ver
            logger.error(f"Nmap open-port tarama hatası: {result.stderr}")

    except Exception as e:
        # Genel hata durumunda hata mesajı ver
        logger.error(f"Error: {e}")
